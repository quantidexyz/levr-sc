---
alwaysApply: true
---

## Testing Rules

- **Always** run tests in -vvv verbose mode.
- **Always** tests handle fork internally.
- **Never** pass fork url in test command.
- **Always** run relevant test cases/files/folders.
- **Intelligently** determine if a test is written just to make the test pass, even when the source code is actually incorrect.
- **Always** run tests from their dir i.e. if you are testing unit tests, run them with --match-path "test/unit/\*.t.sol"

### Build & Test Performance Optimization

The codebase uses Foundry profiles to optimize compilation speed:

**Default Profile:**

- Uses `via_ir = true` - works for all tests, scripts, e2e, and production deployments
- Use for e2e tests, deployment scripts, or full test suite
- Command: `forge test -vvv` or `forge script script/DeployLevr.s.sol`

**Dev Profile (FAST - 20x faster):**

- No `via_ir` compilation (unit tests only; scripts/e2e will fail)
- **Always use this for unit test iteration during development**
- Command: `FOUNDRY_PROFILE=dev forge test --match-path "test/unit/*.t.sol" -vvv`

### Test Command Examples

```bash
# Unit tests (FAST - use dev profile for iteration)
FOUNDRY_PROFILE=dev forge test --match-path "test/unit/*.t.sol" -vvv

# Specific unit test file (FAST)
FOUNDRY_PROFILE=dev forge test --match-path "test/unit/LevrStakingV1.t.sol" -vvv

# Specific test function (FAST)
FOUNDRY_PROFILE=dev forge test --match-test testStake -vvv

# E2E tests (use default profile)
forge test --match-path "test/e2e/*.sol" -vvv

# All tests including e2e (slower, default profile)
forge test -vvv

# Production deployment (use default profile)
forge script script/DeployLevr.s.sol --broadcast --verify
```

**Always** use `FOUNDRY_PROFILE=dev` when iterating on unit tests - it's 20x faster!

> **When confirming a full test suite run (e.g. before merge, tag, or PR status check), you must always run `test/unit/` with the dev profile first (`FOUNDRY_PROFILE=dev`). Only run the full suite including e2e (with default profile) if the unit suite passes. Running all tests with IR enabled is 20-30x slowerâ€”avoid unless required.**

## Code Organization Rules

- **Always** define and import errors/events/enums/structs from interfaces.
- **Always** put analysis md's to the spec folder.

## Documentation & Spec Folder Usage

### Spec Folder Structure (Consolidated Oct 30, 2025)

The `spec/` folder contains **14 active documents** (current work) and `archive/` for historical reference.

**Active Documents (spec/ root):**

```
spec/
â”œâ”€â”€ README.md                          â­ Main navigation hub
â”œâ”€â”€ AUDIT_STATUS.md                    â­ Current audit dashboard
â”‚
â”œâ”€â”€ EXTERNAL_AUDIT_3_ACTIONS.md        ğŸ”´ Active work (18 items to fix)
â”œâ”€â”€ EXTERNAL_AUDIT_2_COMPLETE.md       âœ… Reference (13/13 fixed)
â”‚
â”œâ”€â”€ GOV.md                             ğŸ“– Governance reference
â”œâ”€â”€ FEE_SPLITTER.md                    ğŸ“– Fee distribution
â”œâ”€â”€ USER_FLOWS.md                      ğŸ“– User interactions
â”œâ”€â”€ TESTING.md                         ğŸ“– Test guide
â”‚
â”œâ”€â”€ AUDIT.md                           ğŸ” Security master log
â”œâ”€â”€ HISTORICAL_FIXES.md                ğŸ” Past vulnerabilities
â”œâ”€â”€ COMPARATIVE_AUDIT.md               ğŸ” Industry comparison
â”‚
â”œâ”€â”€ CHANGELOG.md                       ğŸ“… Feature evolution
â”œâ”€â”€ FUTURE_ENHANCEMENTS.md             ğŸ“… Roadmap
â””â”€â”€ CONSOLIDATION_OCT30_2025.md        ğŸ“… Latest consolidation
```

**Directories:**

- `spec/external-2/` - AUDIT 2 detailed reports (7 files, all fixed)
- `spec/external-3/` - AUDIT 3 detailed reports (15 files, 18 items remain)
- `spec/archive/` - Historical documentation (66 files)
  - `archive/audits/` - Completed audit work
  - `archive/consolidations/` - Past consolidations
  - `archive/findings/` - Specific findings
  - `archive/testing/` - Historical test analysis
  - `archive/obsolete-designs/` - Old designs

---

### Where to Find Current Data (Always Start Here)

**ğŸš¨ AUDIT STATUS:**

- **Dashboard:** `spec/AUDIT_STATUS.md` - Current audit status, timeline to mainnet
- **Action Plan:** `spec/EXTERNAL_AUDIT_3_ACTIONS.md` - Active work (18 items with code examples)
- **Security Log:** `spec/AUDIT.md` - Complete security findings and fixes

**ğŸ“– PROTOCOL REFERENCE:**

- **Governance:** `spec/GOV.md` - Mechanics, glossary, quick lookup
- **Fee Distribution:** `spec/FEE_SPLITTER.md` - Architecture, integration
- **User Flows:** `spec/USER_FLOWS.md` - Interaction patterns, edge cases
- **Testing:** `spec/TESTING.md` - Test strategies, commands, utilities

**ğŸ“… PLANNING:**

- **History:** `spec/HISTORICAL_FIXES.md` - Past bugs and lessons learned
- **Evolution:** `spec/CHANGELOG.md` - Feature timeline
- **Future:** `spec/FUTURE_ENHANCEMENTS.md` - Roadmap and V2 ideas
- **Benchmarks:** `spec/COMPARATIVE_AUDIT.md` - vs Compound/MakerDAO/Optimism

---

### Where to Find Historical Data

**Completed Audits:**

- `spec/archive/audits/EXTERNAL_AUDIT_0.md` - First audit (8/8 fixed)
- `spec/archive/audits/EXTERNAL_AUDIT_2_ACTIONS.md` - AUDIT 2 original plan
- `spec/EXTERNAL_AUDIT_2_COMPLETE.md` - AUDIT 2 summary (active for reference)

**Past Consolidations:**

- `spec/archive/consolidations/` - Previous consolidation work
- `spec/CONSOLIDATION_OCT30_2025.md` - Latest consolidation summary

**Specific Findings:**

- `spec/archive/findings/CONFIG_GRIDLOCK_FINDINGS.md` - Gridlock analysis
- `spec/archive/findings/ADERYN_ANALYSIS.md` - Static analysis
- All specific findings integrated into `spec/AUDIT.md`

**Historical Testing:**

- `spec/archive/testing/COVERAGE_ANALYSIS.md` - Historical coverage
- Current coverage in `spec/TESTING.md`

---

### When Adding New Documentation

**Security Findings:**

- **Current audit work** â†’ Update `spec/EXTERNAL_AUDIT_3_ACTIONS.md` OR create new `EXTERNAL_AUDIT_N_ACTIONS.md`
- **Completed audit** â†’ Create `spec/EXTERNAL_AUDIT_N_COMPLETE.md`, move actions to `archive/audits/`
- **All findings** â†’ Always log in `spec/AUDIT.md` (master security log)
- **Fixed bugs** â†’ Add to `spec/HISTORICAL_FIXES.md` with lessons learned

**Protocol Changes:**

- **Governance mechanics** â†’ Update `spec/GOV.md`
- **Fee distribution** â†’ Update `spec/FEE_SPLITTER.md`
- **User interactions** â†’ Update `spec/USER_FLOWS.md`
- **Version tracking** â†’ Update `spec/CHANGELOG.md`

**Analysis & Research:**

- **Test strategies** â†’ Update `spec/TESTING.md`
- **Future features** â†’ Update `spec/FUTURE_ENHANCEMENTS.md`
- **Industry comparison** â†’ Update `spec/COMPARATIVE_AUDIT.md`
- **One-off analysis** â†’ Create in `spec/`, plan to archive when complete

---

### Documentation Consolidation Guidelines

**WHEN TO CONSOLIDATE (Red Flags):**

1. **File count > 20 in spec/ root** â†’ Time to consolidate
2. **Multiple docs on same topic** â†’ Merge into single source of truth
3. **"Which doc is current?"** â†’ Clear sign of duplication
4. **Completed audit has 3+ docs** â†’ Merge into single COMPLETE.md
5. **Temp analysis files aging** â†’ Archive or integrate into main docs

**HOW TO CONSOLIDATE:**

1. **Identify active work:**
   - Current audit action plans (EXTERNAL_AUDIT_N_ACTIONS.md)
   - Protocol references (GOV, FEE_SPLITTER, USER_FLOWS, TESTING)
   - Security logs (AUDIT, HISTORICAL_FIXES)
   - Planning docs (CHANGELOG, FUTURE_ENHANCEMENTS)

2. **Merge overlapping docs:**
   - Audit + Validation + Summary â†’ Single ACTIONS.md
   - Multiple findings on same topic â†’ Into AUDIT.md or HISTORICAL_FIXES.md
   - Temporary analysis â†’ Into appropriate main doc

3. **Archive completed work:**
   - Completed audits â†’ `archive/audits/`
   - Past consolidations â†’ `archive/consolidations/`
   - Specific findings (now in AUDIT.md) â†’ `archive/findings/`
   - Old test analysis â†’ `archive/testing/`
   - Obsolete designs â†’ `archive/obsolete-designs/`

4. **Create clear navigation:**
   - Update `spec/README.md` with current structure
   - Create `spec/AUDIT_STATUS.md` for audit dashboard
   - Add `archive/README.md` for historical navigation
   - Use tables for quick reference

5. **Verify:**
   - No duplicate information
   - All links work
   - Clear "start here" pointers
   - Archive remains accessible

**TARGET STATE:**

- **Active files in spec/:** ~12-15 files (max 20)
- **Single source of truth** per topic
- **Clear entry points** (README, AUDIT_STATUS)
- **Archive organized** with subdirectories

**ARCHIVE ORGANIZATION:**

```
archive/
â”œâ”€â”€ audits/            Completed audit work
â”œâ”€â”€ consolidations/    Past consolidation records
â”œâ”€â”€ findings/          Specific historical findings
â”œâ”€â”€ testing/           Historical test analysis
â””â”€â”€ obsolete-designs/  Old design documents
```

**CONSOLIDATION CHECKLIST:**

```bash
# Step 1: Identify what's active vs complete
# - Active: Current audit work, protocol refs, security logs
# - Complete: Finished audits, old analysis, past consolidations

# Step 2: Merge overlapping documents
# - Look for Audit + Validation + Summary â†’ Merge into ACTIONS
# - Look for duplicate topics â†’ Merge into single doc

# Step 3: Move to archive with organization
mkdir -p spec/archive/{audits,consolidations,findings,testing}
mv COMPLETED_AUDIT.md spec/archive/audits/
mv OLD_ANALYSIS.md spec/archive/findings/

# Step 4: Update navigation
# - Update spec/README.md with current structure
# - Create/update spec/AUDIT_STATUS.md
# - Create/update archive/README.md

# Step 5: Document the consolidation
# Create spec/CONSOLIDATION_[DATE].md explaining what changed
```

---

### Current Spec Status (Oct 30, 2025)

**Active Files:** 14 (clean, maintainable)  
**Archive Files:** 66 (organized, preserved)  
**Last Consolidation:** October 30, 2025  
**Next Consolidation:** When AUDIT 3 complete (est. Nov 2025)

---

### Documentation Best Practices

**DO:**

- âœ… **Start with README.md** - Check navigation first
- âœ… **Use AUDIT_STATUS.md** - For current audit status
- âœ… **Check EXTERNAL_AUDIT_N_ACTIONS.md** - For current work
- âœ… **Update AUDIT.md** - For all security findings
- âœ… **Archive completed work** - Move to archive/ when done
- âœ… **One file per topic** - Merge duplicates
- âœ… **Clear naming** - Use descriptive, unique names

**DON'T:**

- âŒ **Create duplicate docs** - Merge into existing
- âŒ **Create validation/summary separately** - Include in action plan
- âŒ **Keep temp analysis files** - Integrate or archive within 1 week
- âŒ **Reference deleted files** - Update links when consolidating
- âŒ **Create new summaries of summaries** - Update existing or archive
- âŒ **Let spec/ grow past 20 files** - Consolidate when hitting limit

---

### Quick Lookups (Updated Oct 30, 2025)

**Current Status:**

- Audit status â†’ `spec/AUDIT_STATUS.md` â­ **Start here**
- Current work â†’ `spec/EXTERNAL_AUDIT_3_ACTIONS.md` (18 items)
- Security log â†’ `spec/AUDIT.md` (complete history)

**Protocol Reference:**

- Governance â†’ `spec/GOV.md`
- Fee distribution â†’ `spec/FEE_SPLITTER.md`
- User flows â†’ `spec/USER_FLOWS.md`
- Testing â†’ `spec/TESTING.md`

**History & Planning:**

- Past bugs â†’ `spec/HISTORICAL_FIXES.md`
- Past fixes â†’ `spec/EXTERNAL_AUDIT_2_COMPLETE.md`
- Evolution â†’ `spec/CHANGELOG.md`
- Future â†’ `spec/FUTURE_ENHANCEMENTS.md`
- Industry comparison â†’ `spec/COMPARATIVE_AUDIT.md`

**Detailed Reports:**

- AUDIT 2 details â†’ `spec/external-2/` (7 reports)
- AUDIT 3 details â†’ `spec/external-3/` (15 reports)
- Historical work â†’ `spec/archive/` (66 files, organized)

---

### Decision Tree: Where Does This Doc Go?

```
Is it current active work?
â”œâ”€ YES â†’ Is it audit-related?
â”‚  â”œâ”€ YES â†’ Current audit?
â”‚  â”‚  â”œâ”€ YES â†’ EXTERNAL_AUDIT_N_ACTIONS.md
â”‚  â”‚  â””â”€ NO â†’ AUDIT.md (log entry) + HISTORICAL_FIXES.md
â”‚  â””â”€ NO â†’ Which topic?
â”‚     â”œâ”€ Governance â†’ GOV.md
â”‚     â”œâ”€ Fees â†’ FEE_SPLITTER.md
â”‚     â”œâ”€ Flows â†’ USER_FLOWS.md
â”‚     â”œâ”€ Tests â†’ TESTING.md
â”‚     â”œâ”€ Future â†’ FUTURE_ENHANCEMENTS.md
â”‚     â””â”€ Changes â†’ CHANGELOG.md
â””â”€ NO â†’ Archive it
   â”œâ”€ Completed audit â†’ archive/audits/
   â”œâ”€ Old consolidation â†’ archive/consolidations/
   â”œâ”€ Specific finding â†’ archive/findings/
   â”œâ”€ Test analysis â†’ archive/testing/
   â””â”€ Old design â†’ archive/obsolete-designs/
```

---

### Consolidation Triggers

**Consolidate when:**

1. **spec/ has > 20 files** â†’ Target: 12-15 files
2. **Multiple overlapping docs** â†’ Merge into one
3. **Audit complete** â†’ Create COMPLETE.md, archive working docs
4. **Temp analysis > 1 week old** â†’ Integrate into main doc or archive
5. **"Which doc should I read?"** â†’ Too many options, need to merge

**Steps:**

```bash
# 1. List current files
ls spec/*.md | wc -l # If > 20, consolidate!

# 2. Identify duplicates/overlaps
# Look for: *_SUMMARY, *_VALIDATION, *_ACTIONS on same topic

# 3. Merge related docs
# Example: Audit + Validation + Summary â†’ Single ACTIONS.md

# 4. Move completed work
mv COMPLETED_AUDIT_*.md spec/archive/audits/

# 5. Update navigation
# Edit spec/README.md with new structure

# 6. Create consolidation record
# spec/CONSOLIDATION_[DATE].md
```

---

### File Lifecycle

**NEW ANALYSIS:**

1. Create in `spec/` (e.g., `NEW_FINDING_ANALYSIS.md`)
2. Work on it (update frequently)
3. Within 1 week: Integrate into main doc OR archive

**AUDIT WORKFLOW:**

1. Create `EXTERNAL_AUDIT_N_ACTIONS.md` with findings
2. During implementation: Update daily
3. On completion: Create `EXTERNAL_AUDIT_N_COMPLETE.md`
4. Archive: Move actions to `archive/audits/`
5. Keep: COMPLETE.md in spec/ as reference

**MAIN DOCS (Rarely Archive):**

- `AUDIT.md` - Never archive (master log)
- `HISTORICAL_FIXES.md` - Never archive (learning resource)
- `GOV.md`, `FEE_SPLITTER.md`, `USER_FLOWS.md` - Keep current
- `TESTING.md` - Keep current
- `CHANGELOG.md`, `FUTURE_ENHANCEMENTS.md` - Keep current
- `COMPARATIVE_AUDIT.md` - Update as needed

---

### Anti-Patterns (Don't Do This)

âŒ **Create summary of summary** - Update existing or archive  
âŒ **Create temp file and forget** - Integrate within 1 week  
âŒ **Duplicate information** - Merge into single doc  
âŒ **Reference non-existent files** - Update links when moving  
âŒ **Create 3+ docs for same audit** - Use single consolidated doc  
âŒ **Keep completed work in root** - Move to archive/  
âŒ **No README in archive/** - Always add navigation

---

### Maintenance Schedule

**Weekly (During Active Development):**

- Update `AUDIT_STATUS.md` with progress
- Update current audit action plan
- Check for temp files > 1 week old

**After Each Fix:**

- Update `AUDIT.md` with finding + fix
- Update `HISTORICAL_FIXES.md` if bug fix
- Update `CHANGELOG.md` if feature change

**After Audit Completion:**

- Create `EXTERNAL_AUDIT_N_COMPLETE.md`
- Move action docs to `archive/audits/`
- Update `AUDIT_STATUS.md`
- Update `README.md` if structure changed

**Quarterly:**

- Review `FUTURE_ENHANCEMENTS.md`
- Update `COMPARATIVE_AUDIT.md` with industry changes
- Archive obsolete analysis files
- Verify all links work

---

### Example Consolidations

**Good:**

```bash
# Merge 4 audit docs into 1
cat AUDIT_ACTIONS.md AUDIT_VALIDATION.md AUDIT_SUMMARY.md > AUDIT_3_CONSOLIDATED.md
mv AUDIT_3_CONSOLIDATED.md EXTERNAL_AUDIT_3_ACTIONS.md
rm AUDIT_VALIDATION.md AUDIT_SUMMARY.md
# Result: Single source of truth
```

**Bad:**

```bash
# Creating more summaries
cat AUDIT_ACTIONS.md > AUDIT_SUMMARY.md
cat AUDIT_SUMMARY.md > AUDIT_EXECUTIVE_SUMMARY.md
# Result: 3 overlapping docs (confusing!)
```

---

### Current vs Historical

**Use CURRENT (spec/ root) for:**

- âœ… Active audit work in progress
- âœ… Protocol reference (governance, fees, flows)
- âœ… Security master log (all findings)
- âœ… Testing guides
- âœ… Planning docs (changelog, roadmap)

**Use HISTORICAL (spec/archive/) for:**

- âœ… Completed audits (all findings fixed)
- âœ… Past consolidation records
- âœ… Specific findings (now in AUDIT.md)
- âœ… Old test analysis (superseded)
- âœ… Obsolete design explorations

**NEVER:**

- âŒ Reference archive/ for current implementation
- âŒ Put active work in archive/
- âŒ Create docs outside spec/ (except temp, then move within 1 day)

---

## Quick Reference Card

```
NEED TO KNOW CURRENT AUDIT STATUS?
â†’ spec/AUDIT_STATUS.md â­

NEED TO IMPLEMENT FIXES?
â†’ spec/EXTERNAL_AUDIT_3_ACTIONS.md ğŸ”´

NEED GOVERNANCE INFO?
â†’ spec/GOV.md ğŸ“–

NEED TO UNDERSTAND A FLOW?
â†’ spec/USER_FLOWS.md ğŸ“–

NEED TO WRITE TESTS?
â†’ spec/TESTING.md ğŸ“–

NEED SECURITY HISTORY?
â†’ spec/AUDIT.md ğŸ”

NEED TO KNOW WHAT WAS FIXED?
â†’ spec/HISTORICAL_FIXES.md ğŸ”

NEED HISTORICAL CONTEXT?
â†’ spec/archive/ ğŸ“¦

LOST? START HERE:
â†’ spec/README.md â­
```

---

**Last Updated:** October 30, 2025  
**Next Review:** After EXTERNAL_AUDIT_3 completion  
**Maintainer:** Follow these rules to keep spec/ clean!

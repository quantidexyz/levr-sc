#!/bin/bash
# Setup script for Forge Cloud Environment - Coverage Analysis
# This script configures the environment for optimal coverage testing on cloud infrastructure

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "?? Setting up Forge Cloud Environment for Coverage Analysis"
echo "?????????????????????????????????????????????????????????"
echo ""

# Step 1: Verify Foundry is installed
echo "? Step 1: Checking Foundry installation..."
if ! command -v forge &> /dev/null; then
    echo "? Foundry not found. Please install from https://book.getfoundry.sh"
    exit 1
fi
echo "  Foundry version: $(forge --version)"
echo ""

# Step 2: Verify project structure
echo "? Step 2: Verifying project structure..."
if [ ! -f "foundry.toml" ]; then
    echo "? foundry.toml not found"
    exit 1
fi
if [ ! -d "src" ]; then
    echo "? src/ directory not found"
    exit 1
fi
if [ ! -d "test" ]; then
    echo "? test/ directory not found"
    exit 1
fi
echo "  Project structure verified ?"
echo ""

# Step 3: Install dependencies
echo "? Step 3: Installing/updating Foundry dependencies..."
forge install --no-commit 2>/dev/null || true
echo "  Dependencies checked ?"
echo ""

# Step 4: Verify profiles in foundry.toml
echo "? Step 4: Checking Foundry profiles..."
if grep -q "\[profile.dev\]" foundry.toml; then
    echo "  ? dev profile configured"
fi
if grep -q "\[profile.coverage\]" foundry.toml; then
    echo "  ? coverage profile configured"
fi
echo ""

# Step 5: Create cloud environment marker
echo "? Step 5: Creating cloud environment markers..."
touch .forge-cloud-env
echo "CLOUD_ENV=true" >> .forge-cloud-env
echo "SETUP_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .forge-cloud-env
echo "  Cloud environment file created ?"
echo ""

# Step 6: Check test compilation
echo "? Step 6: Verifying test compilation..."
FOUNDRY_PROFILE=dev forge build --no-compile-check 2>&1 | head -20 || true
echo "  Build verification completed ?"
echo ""

# Step 7: Display coverage command instructions
echo "? Step 7: Environment setup complete!"
echo ""
echo "?????????????????????????????????????????????????????????"
echo "?? Coverage Analysis Ready!"
echo "?????????????????????????????????????????????????????????"
echo ""
echo "Quick Start Commands:"
echo ""
echo "1??  Run unit tests (fast - dev profile):"
echo "   FOUNDRY_PROFILE=dev forge test --match-path \"test/unit/*.t.sol\" -vvv"
echo ""
echo "2??  Generate coverage report (fast - coverage profile):"
echo "   FOUNDRY_PROFILE=dev forge coverage --match-path \"test/unit/*.t.sol\" --ir-minimum"
echo ""
echo "3??  Generate LCOV coverage (for HTML report):"
echo "   FOUNDRY_PROFILE=dev forge coverage --match-path \"test/unit/*.t.sol\" --ir-minimum --report lcov"
echo ""
echo "4??  View HTML coverage report:"
echo "   genhtml -o coverage-html coverage.lcov && open coverage-html/index.html"
echo ""
echo "5??  Run specific test file:"
echo "   FOUNDRY_PROFILE=dev forge test --match-path \"test/unit/YourTest.t.sol\" -vvv"
echo ""
echo "?????????????????????????????????????????????????????????"
echo "?? Current Coverage Status:"
echo "?????????????????????????????????????????????????????????"
echo ""
echo "Baseline (Nov 2, 2025):"
echo "  ? Branch Coverage: 29.11% (124/426 branches)"
echo "  ? Line Coverage: 53.52% (1041/1945 lines)"
echo "  ? Target: 100% branch coverage"
echo ""
echo "Current Tasks:"
echo "  1. Remove dead code from RewardMath.sol"
echo "  2. Establish new baseline after cleanup"
echo "  3. Begin Phase 1 foundation tests"
echo ""
echo "?????????????????????????????????????????????????????????"
echo ""
